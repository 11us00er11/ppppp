DROP TABLE IF EXISTS emotion_diary;
DROP TABLE IF EXISTS users;

CREATE DATABASE IF NOT EXISTS gpt_app CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE gpt_app;

CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id VARCHAR(50) COLLATE utf8mb4_bin UNIQUE NOT NULL,
  user_name VARCHAR(50) NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE emotion_diary (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_pk INT NOT NULL,
  mood VARCHAR(50),
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_emotion_diary_user
    FOREIGN KEY (user_pk) REFERENCES users(id)
    ON DELETE CASCADE
);

CREATE INDEX idx_diary_user_created ON emotion_diary(user_pk, created_at);

ALTER TABLE emotion_diary
  ADD COLUMN updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                           ON UPDATE CURRENT_TIMESTAMP AFTER created_at,
  ADD COLUMN deleted_at DATETIME NULL AFTER updated_at;

INSERT INTO users (user_id, user_name, password_hash) VALUES
('minji', '민지', 'scrypt:32768:8:1$FlINJMEGwNRuhRmT$d963e91032feaada470979356c1aa04b51cf8702b358eb4211ac9e4736bb90e66a6a981784395e073a8ffef34cc8c6373a3fd83de23d48cd5c514865d5e30018'),
('jisoo', '지수', 'scrypt:32768:8:1$4t5MtWn7ENc64oly$0d2de3b4a64b271aac58bf91a267c55db89086ff62c6ff2b014a51cfb2b51f694d018357fa4e6a739a3379b8d3e58bacce0bb32c6d561341a4b8811a8151edc6');
